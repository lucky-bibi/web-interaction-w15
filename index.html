<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <title>ì±„íŒ… ìƒë‹´ ì‹œë®¬ë ˆì´ì…˜</title>
    <style>
        /* ===== GLOBAL STYLES ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            background-color: #e9ecef;
            height: 100vh;
            overflow: hidden; /* ì „ì²´ í™”ë©´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            user-select: none;
        }

        /* ===== UTILITY ===== */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* ===== ENTRY SCREEN ===== */
        #entryScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1d1d1d, #2c3e50);
            z-index: 2000;
            flex-direction: column;
            color: white;
            text-align: center;
        }
        .title-box { margin-bottom: 50px; animation: fadeInDown 1s; }
        .game-title { font-size: 3rem; font-weight: bold; margin-bottom: 10px; font-family: 'Gowun Dodum', sans-serif;}
        .game-subtitle { font-size: 1.2rem; opacity: 0.8; }
        
        .difficulty-container { display: flex; gap: 20px; animation: fadeInUp 1s; }
        .diff-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #4895F8, #1A5BF6);
            color: white;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        .diff-btn:hover { background: white; transform: translateY(-5px); color: #222;}

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== MAIN GAME LAYOUT ===== */
        .container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100vh; /* í™”ë©´ ê½‰ ì±„ìš°ê¸° */
            max-width: 1920px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* SIDEBAR LEFT */
        .sidebar-left { 
            background: #2c3e50; 
            color: #ecf0f1; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #34495e; 
            height: 100%; 
            min-height: 0; /* Flex ìì‹ ìŠ¤í¬ë¡¤ í•„ìˆ˜ */
        }
        .sidebar-header { padding: 20px; background: #1a252f; font-weight: bold; flex-shrink: 0; }
        .chat-list { 
            flex: 1 1 0; /* â˜… ì¤‘ìš”: ë‚¨ì€ ê³µê°„ë§Œí¼ë§Œ ì°¨ì§€í•˜ê³  ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
            overflow-y: auto; 
            min-height: 0;
        }
        
        .chat-item { 
            padding: 15px; 
            border-bottom: 1px solid #34495e; 
            cursor: pointer; 
            transition: background 0.2s; 
            position: relative; 
        }
        .chat-item:hover { background: #34495e; }
        .chat-item.active { background: #34495e; border-left: 5px solid #3498db; }
        .chat-item.alert { animation: flashRed 1s infinite; }
        
        @keyframes flashRed { 0% { background-color: #2c3e50; } 50% { background-color: #c0392b; } 100% { background-color: #2c3e50; } }
        
        .patience-track { height: 4px; background: #444; margin-top: 8px; border-radius: 2px; }
        .patience-bar { height: 100%; background: #2ecc71; width: 100%; } 
        .badge-type { font-size:0.7rem; background:#ecf0f1; color:#333; padding:2px 5px; border-radius:3px; margin-left: 5px;}

        /* CENTER CHAT */
        .chat-main { 
            display: flex; 
            flex-direction: column; 
            background: #f8f9fa; 
            height: 100%; 
            min-height: 0;
            overflow: hidden; 
        }
        .chat-header { 
            padding: 15px 25px; 
            background: #fff; 
            border-bottom: 1px solid #dee2e6; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
        }
        .chat-window { 
            flex: 1 1 0; /* â˜… ì¤‘ìš”: ì±„íŒ…ì°½ì´ ë¶€ëª¨ ë†’ì´ë¥¼ ë„˜ì§€ ì•Šê²Œ ê°•ì œí•¨ */
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            min-height: 0; 
            scroll-behavior: smooth;
        }
        
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.4; word-break: break-all; }
        .bubble.customer { align-self: flex-start; background: #fff; border: 1px solid #dee2e6; border-top-left-radius: 2px; }
        .bubble.customer.angry { border-color: #e74c3c; color: #c0392b; background: #fadbd8; font-weight: bold; }
        .bubble.agent { align-self: flex-end; background: #3498db; color: #fff; border-top-right-radius: 2px; }
        .bubble.system { align-self: center; background: rgba(0,0,0,0.05); font-size: 0.8rem; color: #666; padding: 5px 15px; border-radius: 20px; }

        /* INPUT AREA */
        .input-area { 
            background: #fff; 
            padding: 20px; 
            border-top: 1px solid #dee2e6; 
            flex-shrink: 0; /* ì…ë ¥ì°½ì€ ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }
        
        .macro-box { display: flex; gap: 10px; margin-bottom: 10px; }
        .macro-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.9rem;
            border: 1px solid #ced4da; 
            background: #fff;
            border-radius: 5px;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
            font-weight: bold;
        }
        .macro-btn:hover { background: #3498db; color: white; border-color: #3498db; }

        .script-guide { font-size: 0.9rem; color: #e67e22; margin-bottom: 8px; font-weight: bold; }
        .script-box { background: #fdf2e9; padding: 14px; border-radius: 5px; margin-bottom: 14px; border-left: 3px solid #e67e22; color: #555; font-size: 0.95rem; }
        .input-wrapper { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 14px; border: 2px solid #ced4da; border-radius: 5px; outline: none; }
        input[type="text"]:focus { border-color: #3498db; }
        input[type="text"].error { border-color: #e74c3c; animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(5px); } 50% { transform: translateX(-5px); } }
        .btn-send { padding: 0 25px; background: #3498db; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* RIGHT DASHBOARD */
        .sidebar-right { 
            background: #fff; 
            padding: 20px; 
            border-left: 1px solid #dee2e6; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            height: 100%;
            min-height: 0;
            overflow-y: auto;
        }
        .dashboard-card { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef; flex-shrink: 0;}
        .timer { font-size: 3rem; font-weight: bold; color: #2c3e50; text-align: center; font-family: monospace; }
        .timer.danger { color: #e74c3c; animation: pulse 1s infinite; }
        
        .task-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; position: relative; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .task-btn:hover { filter: brightness(1.1); }
        .task-btn:disabled { background: #95a5a6 !important; cursor: not-allowed; opacity: 0.7; }
        .btn-toilet { background: #3943DC; }
        .btn-water { background: #1D7CF8; }
        .btn-meal { background: #28B97A; }
        .check-mark { display: none; }
        .task-btn.done .check-mark { display: block; }
        
        /* OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .overlay.active { display: flex; }
        .overlay-content { background: #fff; color: #333; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px; }
        .progress-bar { width: 300px; height: 10px; background: #555; margin-top: 20px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #e74c3c; width: 0%; }

        /* MANAGER ALERT OVERLAY */
        #managerAlert { z-index: 1500; background: rgba(0,0,0,0.6); }
        .alert-box { background: #fff; padding: 30px; border-radius: 15px; border: 4px solid #e74c3c; text-align: center; width: 400px; animation: bounceIn 0.5s; }
        .alert-title { color: #e74c3c; font-weight: bold; font-size: 1.5rem; margin-bottom: 15px; }
        .alert-desc { color: #333; margin-bottom: 25px; line-height: 1.5; }
        .alert-btns { display: flex; gap: 10px; }
        .btn-alert { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-do { background: #2ecc71; }
        .btn-defer { background: #95a5a6; }
        .btn-defer:disabled { background: #bdc3c7; cursor: not-allowed; text-decoration: line-through; }
        
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* RESULT STYLES */
        .result-badge { display: inline-block; padding: 5px 10px; border-radius: 5px; margin-top: 10px; font-weight: bold; color: white; }
        .badge-bad { background: #e74c3c; }
        .badge-warn { background: #f39c12; }
        .badge-good { background: #2ecc71; }
    </style>
</head>
<body>

<div id="entryScreen" class="flex-center">
    <div class="title-box">
        <div class="game-title">ì•ˆë…•í•˜ì„¸ìš”, ìƒë‹´ì‚¬ë‹˜.<br>ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”.</div>
        <div class="game-subtitle">ì±„íŒ… ìƒë‹´ ê³ ê°ì„¼í„° ì‹œë®¬ë ˆì´ì…˜</div>
    </div>
    <div class="difficulty-container">
        <button class="diff-btn easy" onclick="startGame('easy')">
            ì´ˆê¸‰(Easy)<br><span style="font-size:0.8rem">ë™ì‹œì‘ëŒ€ 2ëª… / 3ë¶„</span>
        </button>
        <button class="diff-btn normal" onclick="startGame('normal')">
            ì¤‘ê¸‰(Normal)<br><span style="font-size:0.8rem">ë™ì‹œì‘ëŒ€ 4ëª… / 3ë¶„</span>
        </button>
        <button class="diff-btn hard" onclick="startGame('hard')">
            ê³ ê¸‰(Hard)<br><span style="font-size:0.8rem">ë¬´í•œ / 3ë¶„</span>
        </button>
    </div>
</div>

<div class="container hidden" id="gameScreen">
    <div class="sidebar-left">
        <div class="sidebar-header">ğŸ’¬ ìƒë‹´ ëŒ€ê¸°ì—´</div>
        <div class="chat-list" id="chatList"></div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <h3 id="currentCustomerName">ìƒë‹´ ëŒ€ê¸° ì¤‘...</h3>
            <span id="currentStatus" style="font-size: 0.8rem; color: #7f8c8d;">-</span>
        </div>
        <div class="chat-window" id="chatWindow">
            <div class="bubble system">ì™¼ìª½ ëª©ë¡ì—ì„œ ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”.</div>
        </div>
        
        <div class="input-area">
            <div class="macro-box">
                <button class="macro-btn" onclick="useMacro('greet')">ğŸ‘‹ ì²«ì¸ì‚¬</button>
                <button class="macro-btn" onclick="useMacro('apology')">ğŸ™ ê³µê°/ì‚¬ê³¼</button>
                <button class="macro-btn" onclick="useMacro('closing')">ğŸ™‡ ëì¸ì‚¬</button>
            </div>
            <div class="script-guide">â–¼ ì•„ë˜ ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì—”í„°ë¡œ ì „ì†¡)</div>
            <div class="script-box" id="scriptTarget">...</div>
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="ë‚´ìš© ì…ë ¥..." disabled onpaste="return false;" autocomplete="off">
                <button class="btn-send" id="btnSend">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div class="sidebar-right">
        <div class="dashboard-card timer-box">
            <div style="font-size: 0.9rem; color: #7f8c8d;">í‡´ê·¼ê¹Œì§€ ë‚¨ì€ ì‹œê°„</div>
            <div class="timer" id="gameTimer">180</div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 0.9rem; margin-bottom: 10px; font-weight: bold; color:#e74c3c;">âš ï¸ ê¶Œì¥ ë¯¸ì…˜ (ê±´ê°• ê´€ë¦¬)</div>
            <button class="task-btn btn-toilet" id="btnToilet" onclick="doPersonalTask('toilet', 5)">
                <span>ğŸš½ í™”ì¥ì‹¤ (5ì´ˆ)</span> <span class="check-mark">âœ…</span>
            </button>
            <button class="task-btn btn-water" id="btnWater" onclick="doPersonalTask('water', 3)">
                <span>ğŸ’§ ë¬¼ ë§ˆì‹œê¸° (3ì´ˆ)</span> <span class="check-mark">âœ…</span>
            </button>
            <button class="task-btn btn-meal" id="btnMeal" onclick="doPersonalTask('meal', 5)">
                <span>ğŸ™ ì‹ì‚¬ (5ì´ˆ)</span> <span class="check-mark">âœ…</span>
            </button>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 0.9rem; margin-bottom: 5px;">ì‹¤ì  í˜„í™©</div>
            <div>ìƒë‹´ ì¢…ë£Œ(ê±´): <span id="scoreResolved" style="font-weight:bold; color: #2ecc71">0</span></div>
            <div>ë¶ˆë§Œ: <span id="scoreAngry" style="font-weight:bold; color: #e74c3c">0</span></div>
            <div style="margin-top:5px; border-top:1px solid #ddd; padding-top:5px;">
                ğŸ“ ê´€ë¦¬ì ë³´ê³ : <span id="statusManagerTask" style="font-weight:bold; color: #e74c3c">ë¯¸ì œì¶œ</span>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="taskOverlay">
    <h2 id="taskTitle">ì—…ë¬´ ì¤‘ë‹¨...</h2>
    <div class="progress-bar"><div class="progress-fill" id="taskProgress"></div></div>
    <p style="margin-top:15px; font-size: 0.9rem; color: #ccc;">(ê³ ê° ì±„íŒ…ì€ ê³„ì† ìŒ“ì´ê³  ìˆìŠµë‹ˆë‹¤)</p>
</div>

<div class="overlay" id="managerAlert">
    <div class="alert-box">
        <div class="alert-title">ğŸš¨ ê´€ë¦¬ì í˜¸ì¶œ ğŸš¨</div>
        <div class="alert-desc">
            ì„œë¥˜ ì‘ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
            ì—…ë¬´ ì‹œê°„ ë‚´ì— ì œì¶œí•˜ì„¸ìš”.<br>
            <br>
            <span style="font-size:0.9rem; color:#e74c3c;" id="deferStatusText"></span>
        </div>
        <div class="alert-btns">
            <button class="btn-alert btn-do" onclick="resolveManagerTask('do')">ì§€ê¸ˆ ì´í–‰ (5ì´ˆ)</button>
            <button class="btn-alert btn-defer" id="btnDefer" onclick="resolveManagerTask('defer')">ë¯¸ë£¨ê¸°</button>
        </div>
    </div>
</div>

<div class="overlay" id="resultOverlay">
    <div class="overlay-content">
        <h2 id="resultTitle">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</h2>
        
        <div style="text-align: left; background: #f1f1f1; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <div>âœ… ì²˜ë¦¬ ê±´ìˆ˜: <span id="finalScore">0</span>ê±´</div>
            <div>ğŸ˜¡ ë¶ˆë§Œ ê±´ìˆ˜: <span id="finalAngry">0</span>ê±´</div>
            <div>â¤ï¸ ë¯¸ì…˜ ìˆ˜í–‰: <span id="finalTasks">0</span>/3 ì™„ë£Œ</div>
            <div>ğŸ“ ê´€ë¦¬ì ë³´ê³ : <span id="finalManagerResult">ë¯¸ì œì¶œ</span></div>
        </div>

        <p style="margin: 20px 0; line-height: 1.6; font-size: 1rem;" id="resultDesc"></p>
        <button class="task-btn" style="background: #2c3e50; justify-content: center;" onclick="location.reload()">ë‹¤ì‹œ ì¶œê·¼í•˜ê¸°</button>
    </div>
</div>

<script>
    // === GAME CONFIGURATION ===
    const SETTINGS = {
        easy: { time: 180, spawnRate: 4000, decay: 0.8, maxActive: 2, totalLimit: 10 },
        normal: { time: 180, spawnRate: 3000, decay: 1.2, maxActive: 4, totalLimit: 999 },
        hard: { time: 180, spawnRate: 2000, decay: 1.8, maxActive: 6, totalLimit: 999 }
    };
    
    // â–¼â–¼â–¼ ë©˜íŠ¸ ìˆ˜ì •: "ë°°ë‹¬ì˜ ì¡±ì†" ì œê±°í•˜ê³  "ë°°ë‹¬ ê³ ê°ì„¼í„°"ë¡œ í†µì¼ â–¼â–¼â–¼
    const SCENARIOS = [
        { 
            type: "ë°°ë‹¬ì§€ì—°", 
            names: ["ê¹€ì„±ê²©", "ì´ê¸‰í•´", "ë°•ì¬ì´‰"], 
            start: ["ë°°ë‹¬ ì–¸ì œ ì™€ìš”?", "1ì‹œê°„ ì§€ë‚¬ì–´ìš”.", "ë°°ë‹¬ ì¶œë°œì€ í–ˆë‚˜ìš”?"], 
            steps: [
                {t: "ì•ˆë…•í•˜ì„¸ìš”, ë°°ë‹¬ ê³ ê°ì„¼í„°ì…ë‹ˆë‹¤.", r: "ë„¤ ë¹¨ë¦¬ ì¢€ í™•ì¸í•´ì£¼ì„¸ìš”."}, // ìˆ˜ì •ë¨
                {t: "ë„¤ ê³ ê°ë‹˜, ì£¼ë¬¸ ì •ë³´ ë¨¼ì € í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.", r: "ë¹¨ë¦¬ ì¢€ ë³´ì„¸ìš”."}, 
                {t: "í˜„ì¬ ê¸°ì‚¬ë‹˜ ìœ„ì¹˜ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œìš”.", r: "ì•„ í˜„ê¸°ì¦ ë‚˜ìš”."}, 
                {t: "ì£„ì†¡í•©ë‹ˆë‹¤. 5ë¶„ ë‚´ ë„ì°© ì˜ˆì •ì…ë‹ˆë‹¤.", r: "ì•Œê² ìŠµë‹ˆë‹¤."},
                {t: "ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”.", r: ""} 
            ] 
        },
        { 
            type: "ìŒì‹ëˆ„ë½", 
            names: ["ìµœì½œë¼", "ì •ë‹¨ë¬´ì§€", "ê°•ì†ŒìŠ¤"], 
            start: ["ì‚¬ì´ë“œ ë©”ë‰´ê°€ ì•ˆ ì™”ì–´ìš”.", "ì½œë¼ ë¹ ì¡ŒëŠ”ë°ìš”?", "ì†ŒìŠ¤ê°€ ì—†ì–´ìš”."], 
            steps: [
                {t: "ì•ˆë…•í•˜ì„¸ìš”, ë°°ë‹¬ ê³ ê°ì„¼í„°ì…ë‹ˆë‹¤.", r: "ë©”ë‰´ê°€ ë¹ ì¡Œì–´ìš”."}, // ìˆ˜ì •ë¨
                {t: "ë¶ˆí¸ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤. ëˆ„ë½ëœ ë©”ë‰´ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤.", r: "ì–´ë–»ê²Œ í•˜ì‹¤ ê±°ì˜ˆìš”?"}, 
                {t: "ë§¤ì¥ í™•ì¸ í›„ ì‹ ì†í•˜ê²Œ ì²˜ë¦¬í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.", r: "ì§€ê¸ˆ ë‹¹ì¥ í•„ìš”í•˜ë‹¤ê³ ìš”."}, 
                {t: "ë„¤ ê³ ê°ë‹˜, ë°”ë¡œ ì¬ë°°ë‹¬ ì ‘ìˆ˜í•´ ë“œë ¸ìŠµë‹ˆë‹¤.", r: "ë„¤ ì•Œê² ìŠµë‹ˆë‹¤."},
                {t: "ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”.", r: ""}
            ] 
        },
        { 
            type: "ì£¼ì†Œë³€ê²½", 
            names: ["í•œì´ì‚¬", "ì˜¤ì „ì…", "ì¥ì‹¤ìˆ˜"], 
            start: ["ì£¼ì†Œì§€ ë³€ê²½ ê°€ëŠ¥í•œê°€ìš”?", "íšŒì‚¬ë¡œ ì‹œì¼°ëŠ”ë° ì§‘ìœ¼ë¡œ ë°”ê¿€ë˜ìš”.", "ì£¼ì†Œë¥¼ ì˜ëª» ì ì—ˆì–´ìš”."], 
            steps: [
                {t: "ì•ˆë…•í•˜ì„¸ìš”, ë°°ë‹¬ ê³ ê°ì„¼í„°ì…ë‹ˆë‹¤.", r: "ì£¼ì†Œ ì¢€ ë°”ê¿”ì£¼ì„¸ìš”."}, // ìˆ˜ì •ë¨
                {t: "ë„¤ ê³ ê°ë‹˜, ì£¼ë¬¸ ë²ˆí˜¸ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.", r: "ë„¤ ë¹¨ë¦¬ìš”."}, 
                {t: "ë³€ê²½í•˜ì‹¤ ì •í™•í•œ ì£¼ì†Œì§€ ë§ì”€í•´ ì£¼ì„¸ìš”.", r: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." }, 
                {t: "ë„¤ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ì†Œ ë³€ê²½ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.", r: "ê°ì‚¬í•©ë‹ˆë‹¤."},
                {t: "ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”.", r: ""}
            ] 
        }
    ];

    const GREETING_STARTS = ["ì•ˆë…•í•˜ì„¸ìš”.", "ì €ê¸°ìš”.", "ìƒë‹´ì›ë¶„?"];
    const ANGRY_TEXTS = ["ë‹µë³€ ì•ˆ í•˜ì„¸ìš”?", "ë“£ê³  ìˆì–´ìš”?", "ì‚¬ëŒ ìˆë‚˜ìš”?", "ì¥ë‚œí•˜ì„¸ìš”?", "ì•„ ë‹µë‹µí•´"];

    let state = {
        isPlaying: false, difficulty: 'normal', time: 180, decayRate: 1.0,
        customers: [], activeId: null, totalSpawned: 0,
        score: { resolved: 0, angry: 0 }, tasks: { toilet: false, water: false, meal: false },
        managerTaskDone: false, 
        deferCount: 0, 
        intervals: []
    };

    const els = {
        entry: document.getElementById('entryScreen'), game: document.getElementById('gameScreen'),
        list: document.getElementById('chatList'), window: document.getElementById('chatWindow'),
        input: document.getElementById('userInput'), target: document.getElementById('scriptTarget'),
        timer: document.getElementById('gameTimer'), 
        statusManagerTask: document.getElementById('statusManagerTask'),
        managerAlert: document.getElementById('managerAlert'),
        deferStatusText: document.getElementById('deferStatusText'),
        btnDefer: document.getElementById('btnDefer')
    };

    function startGame(difficulty) {
        els.entry.classList.add('hidden');
        els.game.classList.remove('hidden');

        state.difficulty = difficulty;
        const setting = SETTINGS[difficulty];
        state.time = setting.time;
        state.decayRate = setting.decay;
        state.isPlaying = true;
        state.totalSpawned = 0;

        spawnCustomer(); 
        
        state.intervals.push(setInterval(gameLoop, 100));
        state.intervals.push(setInterval(spawnCustomer, setting.spawnRate));
        state.intervals.push(setInterval(checkManagerTaskTrigger, 20000));

        els.input.disabled = false;
        els.input.focus();
        updateTimer();
    }

    function gameLoop() {
        if (!state.isPlaying) return;
        state.time -= 0.1;
        updateTimer();
        if (state.time <= 0) endGame();

        state.customers.forEach(c => {
            if (c.done) return;
            c.patience -= 0.1 * state.decayRate;

            if (c.patience < 50 && !c.angry && Math.random() < 0.01) {
                addMsg(c.id, 'customer', ANGRY_TEXTS[Math.floor(Math.random() * ANGRY_TEXTS.length)], true);
            }
            if (c.patience <= 0) failCustomer(c);
        });
        
        updatePatienceBars();
    }

    function updatePatienceBars() {
        state.customers.forEach(c => {
            const bar = document.getElementById(`bar-${c.id}`);
            if (bar) {
                bar.style.width = Math.max(0, c.patience) + '%';
                bar.style.background = c.patience > 50 ? '#2ecc71' : '#e74c3c';
            }
        });
    }

    function spawnCustomer() {
        const setting = SETTINGS[state.difficulty];
        if (state.customers.filter(c => !c.done).length >= setting.maxActive) return;
        if (state.totalSpawned >= setting.totalLimit) return;

        state.totalSpawned++;
        const s = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
        let steps = JSON.parse(JSON.stringify(s.steps));
        let startMsg = s.start[Math.floor(Math.random() * s.start.length)];
        
        // ì¸ì‚¿ë§ ëœë¤ í™•ë¥  ë¡œì§ (ë‹¨ìˆœí™”)
        if (Math.random() < 0.3) {
            startMsg = GREETING_STARTS[Math.floor(Math.random() * GREETING_STARTS.length)];
        }

        const newC = {
            id: Date.now() + Math.random(),
            name: s.names[Math.floor(Math.random() * s.names.length)],
            type: s.type, steps: steps, stepIdx: 0,
            patience: 100, msgs: [{ sender: 'customer', text: startMsg, angry: false }],
            angry: false, done: false
        };

        state.customers.push(newC);
        if (!state.activeId) selectCustomer(newC.id);
        
        renderChatList();
    }

    window.useMacro = function(type) {
        if (!state.isPlaying || !state.activeId) return;
        
        const c = state.customers.find(x => x.id === state.activeId);
        if (!c || c.done) return;

        if (type === 'apology') {
            const apologyText = "ë§ì´ ë¶ˆí¸í•˜ì…¨ì£ . ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤.";
            addMsg(c.id, 'agent', apologyText);
            c.patience = Math.min(100, c.patience + 15);
            addMsg(c.id, 'system', "â¤ï¸ ê³ ê°ë‹˜ì´ ì§„ì •í–ˆìŠµë‹ˆë‹¤. (ì¸ë‚´ì‹¬ íšŒë³µ)");
            return;
        }

        if (type === 'greet') {
            if (c.stepIdx === 0) {
                forcePassStep(c);
            } else {
                addMsg(c.id, 'system', "âŒ ì§€ê¸ˆì€ ì¸ì‚¬ë¥¼ í•  íƒ€ì´ë°ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }
        } else if (type === 'closing') {
            if (c.stepIdx === c.steps.length - 1) {
                forcePassStep(c);
            } else {
                addMsg(c.id, 'system', "âŒ ì•„ì§ ìƒë‹´ì´ ëë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        }
        els.input.focus();
    };

    function forcePassStep(c) {
        const targetText = c.steps[c.stepIdx].t;
        addMsg(c.id, 'agent', targetText);
        processStepSuccess(c);
    }

    function checkManagerTaskTrigger() {
        if (!state.isPlaying || state.managerTaskDone) return;
        if (Math.random() < 0.5) showManagerAlert();
    }

    function showManagerAlert() {
        els.deferStatusText.innerText = `í˜„ì¬ ë¯¸ë£¨ê¸° ì‚¬ìš©: ${state.deferCount} / 3íšŒ`;
        
        if (state.deferCount >= 3) {
            els.btnDefer.disabled = true;
            els.btnDefer.innerText = "ë¯¸ë£¨ê¸° ë¶ˆê°€ (íšŸìˆ˜ ì´ˆê³¼)";
        } else {
            els.btnDefer.disabled = false;
            els.btnDefer.innerText = "ë¯¸ë£¨ê¸°";
        }
        els.managerAlert.classList.add('active');
    }

    window.resolveManagerTask = function(action) {
        els.managerAlert.classList.remove('active');
        if (action === 'do') {
            doPersonalTask('manager', 5);
        } else {
            state.deferCount++;
            setTimeout(checkManagerTaskTrigger, 15000); 
        }
    }

    function selectCustomer(id) {
        state.activeId = id;
        els.input.value = "";
        els.input.classList.remove('error');
        els.input.disabled = false;
        els.input.focus();
        
        renderChatList();
        renderChatWindow();
    }

    function failCustomer(c) {
        if (c.done) return;
        c.done = true;
        c.angry = true;
        state.score.angry++;
        addMsg(c.id, 'customer', "ì•„ ëì–´ìš”. ìƒë‹´ ì¢…ë£Œí•©ë‹ˆë‹¤. (í‰ì : â­ - ìµœì•…)", true);
        addMsg(c.id, 'system', "ìƒë‹´ ì‹¤íŒ¨ (ë¶ˆë§Œ ì ‘ìˆ˜ë¨)");
        updateDashboard();
        if (state.activeId === c.id) renderChatWindow();
    }

    function renderChatList() {
        els.list.innerHTML = "";
        state.customers.forEach(c => {
            if (c.done && state.activeId !== c.id) return;
            
            const div = document.createElement('div');
            div.className = `chat-item ${state.activeId === c.id ? 'active' : ''}`;
            if (c.patience < 30 && !c.done) div.classList.add('alert');
            
            const color = c.patience > 50 ? '#2ecc71' : '#e74c3c';
            
            div.innerHTML = `
                <div style="font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
                    <span>${c.name}</span>
                    <span class="badge-type">${c.type}</span>
                </div>
                <div style="font-size:0.8rem; color:#bdc3c7; margin:5px 0;">${c.msgs[c.msgs.length-1].text.substring(0,18)}...</div>
                <div class="patience-track"><div id="bar-${c.id}" class="patience-bar" style="width:${Math.max(0, c.patience)}%; background:${color}"></div></div>
            `;
            
            div.onclick = () => selectCustomer(c.id);
            els.list.appendChild(div);
        });
    }

    function renderChatWindow() {
        const c = state.customers.find(x => x.id === state.activeId);
        if (!c) {
            els.window.innerHTML = '<div class="bubble system">ì™¼ìª½ ëª©ë¡ì—ì„œ ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
            document.getElementById('currentCustomerName').innerText = "ëŒ€ê¸° ì¤‘";
            document.getElementById('currentStatus').innerText = "-";
            els.target.innerText = "...";
            return;
        }

        document.getElementById('currentCustomerName').innerText = `${c.name} ê³ ê°ë‹˜`;
        document.getElementById('currentStatus').innerText = c.type;

        els.window.innerHTML = "";
        c.msgs.forEach(m => {
            const b = document.createElement('div');
            b.className = `bubble ${m.sender} ${m.angry ? 'angry' : ''}`;
            b.innerText = m.text;
            els.window.appendChild(b);
        });
        els.window.scrollTop = els.window.scrollHeight;

        if (c.done) {
            els.target.innerText = c.angry ? "ì‹¤íŒ¨í•œ ìƒë‹´ì…ë‹ˆë‹¤." : "ì™„ë£Œëœ ìƒë‹´ì…ë‹ˆë‹¤.";
            els.input.disabled = true;
        } else {
            els.target.innerText = c.steps[c.stepIdx].t;
            els.input.disabled = false;
        }
    }

    function updateTimer() {
        els.timer.innerText = Math.ceil(state.time);
        if (state.time < 30) els.timer.classList.add('danger');
    }

    function updateDashboard() {
        document.getElementById('scoreResolved').innerText = state.score.resolved;
        document.getElementById('scoreAngry').innerText = state.score.angry;
    }

    function checkSimilarity(s1, s2) {
        s1 = s1.replace(/\s/g, '').toLowerCase(); 
        s2 = s2.replace(/\s/g, '').toLowerCase();
        
        if (s1 === s2) return 100;
        if (s1.length < 2 || s2.length < 2) return 0; 

        const costs = new Array();
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i == 0) costs[j] = j;
                else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        
        const longer = Math.max(s1.length, s2.length);
        const similarity = (longer - costs[s2.length]) / longer;
        return similarity * 100;
    }

    function processStepSuccess(c) {
        els.input.value = "";
        c.patience = Math.min(100, c.patience + 20); 
        c.stepIdx++;
        if (c.stepIdx >= c.steps.length) {
            c.done = true;
            state.score.resolved++;
            
            const rand = Math.random();
            let ratingMsg = "";
            if (rand < 0.7) ratingMsg = "(í‰ì : â­ - 1ê°œ)"; 
            else if (rand < 0.9) ratingMsg = "(í‰ì  ì—†ìŒ)"; 
            else ratingMsg = "(í‰ì : â­â­â­â­â­ - 5ê°œ)"; 

            addMsg(c.id, 'system', `ìƒë‹´ ì™„ë£Œ ${ratingMsg}`);
            updateDashboard();
        } else {
            setTimeout(() => {
                if(!c.done && !c.angry) addMsg(c.id, 'customer', c.steps[c.stepIdx-1].r);
            }, 600);
        }
        if (state.activeId === c.id) renderChatWindow();
    }

    els.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const c = state.customers.find(x => x.id === state.activeId);
            if (!c || c.done) return;

            const targetText = c.steps[c.stepIdx].t; 
            const userText = els.input.value.trim(); 

            const similarity = checkSimilarity(targetText, userText);

            if (similarity >= 80) { 
                addMsg(c.id, 'agent', targetText);
                processStepSuccess(c);
            } else {
                els.input.classList.add('error');
                setTimeout(() => els.input.classList.remove('error'), 300);
            }
        }
    });

    document.getElementById('btnSend').addEventListener('click', () => {
        const event = new KeyboardEvent('keydown', { key: 'Enter' });
        els.input.dispatchEvent(event);
    });

    function addMsg(id, sender, text, angry = false) {
        const c = state.customers.find(x => x.id === id);
        if (c) {
            c.msgs.push({ sender, text, angry });
            if (state.activeId === id) renderChatWindow();
            renderChatList(); 
        }
    }

    window.doPersonalTask = function(type, duration) {
        if (!state.isPlaying) return;
        
        if (type === 'manager') {
            state.managerTaskDone = true;
            els.statusManagerTask.innerText = "ì œì¶œ ì™„ë£Œ";
            els.statusManagerTask.style.color = "#2ecc71";
        } else {
            if(state.tasks[type]) return;
            state.tasks[type] = true;
            const btn = document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1));
            btn.classList.add('done');
            btn.disabled = true;
        }

        const overlay = document.getElementById('taskOverlay');
        const bar = document.getElementById('taskProgress');
        const title = document.getElementById('taskTitle');
        
        if (type === 'manager') title.innerText = "ğŸš¨ ë³´ê³  ì„œë¥˜ ì‘ì„± ì¤‘...";
        else title.innerText = type === 'toilet' ? "í™”ì¥ì‹¤ ë‹¤ë…€ì˜¤ëŠ” ì¤‘..." : type === 'water' ? "ìˆ˜ë¶„ ë³´ì¶© ì¤‘..." : "ì‹ì‚¬ ì¤‘...";

        overlay.classList.add('active');
        bar.style.transition = `width ${duration}s linear`;
        els.input.disabled = true;
        setTimeout(() => bar.style.width = "100%", 50);

        setTimeout(() => {
            overlay.classList.remove('active');
            bar.style.width = "0%";
            bar.style.transition = 'none';
            els.input.disabled = false;
            els.input.focus();
        }, duration * 1000);
    };

    function endGame() {
        state.isPlaying = false;
        state.intervals.forEach(clearInterval);
        document.getElementById('resultOverlay').classList.add('active');
        
        const tasksCount = Object.values(state.tasks).filter(Boolean).length;
        const { resolved, angry } = state.score;
        const managerResult = state.managerTaskDone ? "ì œì¶œ ì™„ë£Œ" : "ë¯¸ì œì¶œ (ê²½ê³ )";

        document.getElementById('finalScore').innerText = resolved;
        document.getElementById('finalAngry').innerText = angry;
        document.getElementById('finalTasks').innerText = tasksCount;
        document.getElementById('finalManagerResult').innerText = managerResult;
        
        if (!state.managerTaskDone) {
            document.getElementById('finalManagerResult').style.color = "#e74c3c";
            document.getElementById('finalManagerResult').style.fontWeight = "bold";
        } else {
            document.getElementById('finalManagerResult').style.color = "#2ecc71";
        }

        let results = [];
        let isBad = false;

        if (angry >= resolved && angry > 0) {
            results.push("ğŸ˜¡ <b>[ì‹¤ì  ì£¼ì˜]</b> ê³ ê° ë¶ˆë§Œì´ ë„ˆë¬´ ë§ì•„ ì¬ê³„ì•½ì´ ì–´ë µìŠµë‹ˆë‹¤.");
            isBad = true;
        }
        if (tasksCount < 3) {
            results.push("ğŸ¥ <b>[ê±´ê°• ì•…í™”]</b> í™”ì¥ì‹¤ì´ë‚˜ ì‹ì‚¬ëŠ” ì±™ê¸°ì…”ì•¼ í•´ìš”.");
            isBad = true;
        }
        if (!state.managerTaskDone) {
            results.push("ğŸš¨ <b>[ê´€ë¦¬ì ì£¼ì˜]</b> ì—…ë¬´ìƒ ë³´ê³ ê°€ ëˆ„ë½ë˜ì–´ ê´€ë¦¬ìë¡œë¶€í„° ì£¼ì˜ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");
            isBad = true;
        }

        const desc = document.getElementById('resultDesc');
        if (isBad) {
            desc.innerHTML = results.join("<br><br>"); 
        } else {
            desc.innerHTML = "ğŸ† <b>[ìµœìš°ìˆ˜ ì‚¬ì›]</b> ì™„ë²½í•©ë‹ˆë‹¤! ê³ ê° ì‘ëŒ€, ê±´ê°• ê´€ë¦¬, ìƒì‚¬ ì—…ë¬´ê¹Œì§€ ëª¨ë‘ í•´ëƒˆìŠµë‹ˆë‹¤.<br>ë³´ë„ˆìŠ¤ì™€ í•¨ê»˜ ì¹¼í‡´ê·¼ í•˜ì„¸ìš”!";
        }
    }
</script>

</body>
</html>